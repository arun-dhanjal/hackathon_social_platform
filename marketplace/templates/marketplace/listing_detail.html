{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/marketplace.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                {% if listing.image %}
                <img src="{{ listing.image.url }}" class="card-img-top listing-detail-img" alt="{{ listing.title }}">
                {% endif %}
                <div class="card-body">
                    <h2 class="card-title">{{ listing.title }}</h2>
                    <p class="card-text">{{ listing.description }}</p>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <p><strong>Starting Price:</strong> ${{ listing.starting_price }}</p>
                            {% if listing.reserve_price %}
                            <p><strong>Reserve Price:</strong> ${{ listing.reserve_price }}</p>
                            {% endif %}
                            <p><strong>Minimum Increment:</strong> ${{ listing.min_increment }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Seller:</strong> {{ listing.seller.username }}</p>
                            <p><strong>Created:</strong> {{ listing.created_at|date:"M d, Y H:i" }}</p>
                            {% if listing.ends_at %}
                            <p><strong>Ends:</strong> {{ listing.ends_at|date:"M d, Y H:i" }}</p>
                            {% endif %}
                        </div>
                    </div>

                    {% if is_ended %}
                    <div class="alert alert-warning mt-3">
                        <strong>This auction has ended.</strong>
                    </div>
                    {% elif listing.is_sold %}
                    <div class="alert alert-success mt-3">
                        <strong><i class="bi bi-check-circle"></i> This item has been sold!</strong>
                    </div>
                    {% endif %}
                    
                    {% if is_seller and not listing.is_sold %}
                    <div class="mt-3">
                        {% if not listing.bids.exists %}
                        <form method="POST" action="{% url 'marketplace:delete_listing' listing.pk %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this listing?');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Delete Listing
                            </button>
                        </form>
                        {% else %}
                        <p class="text-muted"><small><i class="bi bi-info-circle"></i> Cannot delete listing with existing bids.</small></p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Bid Form -->
            {% if not is_ended and not listing.is_sold and not is_seller and user.is_authenticated %}
            <div class="card mb-4">
                <div class="card-body">
                    <h4>Place Your Bid</h4>
                    <form method="POST" action="{% url 'marketplace:place_bid' listing.pk %}" id="bidForm">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="amount">Bid Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input 
                                    type="number" 
                                    class="form-control" 
                                    id="amount" 
                                    name="amount" 
                                    step="0.01" 
                                    min="{{ minimum_bid }}"
                                    value="{{ minimum_bid }}"
                                    required>
                            </div>
                            <small class="form-text text-muted">Minimum bid: ${{ minimum_bid }}</small>
                        </div>
                        <button type="submit" class="btn btn-primary mt-2">Place Bid</button>
                    </form>
                </div>
            </div>
            {% elif is_seller %}
            <div class="alert alert-info">
                You cannot bid on your own listing.
            </div>
            {% elif not user.is_authenticated %}
            <div class="alert alert-info">
                Please <a href="{% url 'login' %}">login</a> to place a bid.
            </div>
            {% endif %}
        </div>

        <!-- Bids Sidebar -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h4>Current Bids</h4>
                </div>
                <div class="card-body">
                    {% if listing.is_sold %}
                    <div class="alert alert-success">
                        <strong><i class="bi bi-check-circle"></i> SOLD!</strong><br>
                        Winning bid: ${{ listing.accepted_bid.amount }}<br>
                        Winner: {{ listing.accepted_bid.bidder.username }}
                    </div>
                    {% elif highest_bid %}
                    <div class="alert alert-success">
                        <strong>Highest Bid:</strong> ${{ highest_bid.amount }}<br>
                        <small>by {{ highest_bid.bidder.username }} on {{ highest_bid.created_at|date:"M d, H:i" }}</small>
                    </div>
                    {% else %}
                    <p class="text-muted">No bids yet. Be the first!</p>
                    {% endif %}

                    {% if bids %}
                    <h5 class="mt-3">Bid History</h5>
                    <ul class="list-group list-group-flush">
                        {% for bid in bids %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${{ bid.amount }}</strong>
                                    {% if listing.accepted_bid and listing.accepted_bid.id == bid.id %}
                                    <span class="badge bg-success">ACCEPTED</span>
                                    {% elif bid.id == highest_bid.id %}
                                    <span class="badge bg-primary">HIGHEST</span>
                                    {% endif %}
                                    <br>
                                    <small>{{ bid.bidder.username }}</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted d-block">{{ bid.created_at|date:"M d, H:i" }}</small>
                                    
                                    <!-- Accept Bid Button (only for seller) -->
                                    {% if is_seller and not listing.is_sold and user.is_authenticated %}
                                    <form method="POST" action="{% url 'marketplace:accept_bid' listing.pk bid.pk %}" class="mt-1" onsubmit="return confirm('Accept this bid of ${{ bid.amount }} from {{ bid.bidder.username }}? This will mark the item as sold.');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="bi bi-check-lg"></i> Accept
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    
                    <!-- Seller Note -->
                    {% if is_seller and bids and not listing.is_sold %}
                    <div class="alert alert-info mt-3">
                        <small><i class="bi bi-info-circle"></i> <strong>Seller Note:</strong> You can accept any bid, even if it's below your reserve price.</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Client-side validation
document.getElementById('bidForm')?.addEventListener('submit', function(e) {
    const amount = parseFloat(document.getElementById('amount').value);
    const minimum = parseFloat({{ minimum_bid }});
    
    if (amount < minimum) {
        e.preventDefault();
        alert(`Bid must be at least $${minimum.toFixed(2)}`);
        return false;
    }
});
</script>
{% endblock %}
