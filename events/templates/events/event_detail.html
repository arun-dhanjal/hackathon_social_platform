{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}


{% block content %}

<div class="container">
    <div class="row events-pages-section">
        <div class="col text-end">
            <p><a href="{% url 'events:events_feed' %}" class="btn btn-muted">Events</a></p>
        </div>
        <div class="col text-start">
            <p><a href="{% url 'events:my_events' %}" class="btn btn-muted">My Events</a></p>
        </div>
    </div>
    <div class="row justify-content-center">
        <!-- Center the content by using a wider column and centering the row -->
        <div class="col-12 col-md-8 col-lg-6 mt-1">
            <div class="card event-detail text-center mb-3">
                <div class="image-container mt-5 mb-4">
                {% if "placeholder" in event.featured_image.url %}
                    <img class="img-fluid" src="{% static 'images/event_default.webp' %}"
                         alt="placeholder image">
                {% else %}
                    <img class="img-fluid" src="{{ event.featured_image.url }}" alt="{{ event.title }}">
                {% endif %}
                </div>
                <div class="event-info">
                    <h1 class="event-title mx-2">{{ event.title }}</h1>
                    <p class="event-subtitle">Hosted by {{ event.host }}</p>
                    <hr>
                    <div id="events-info" class="row">
                        <div class="col text-end">
                            <p><i class="bi bi-calendar-event"></i> {{ event.date }}</p>
                        </div>
                        <div class="col text-start">
                            <p><i class="bi bi-geo-alt-fill"></i> {{ event.location }}</p>
                        </div>
                    </div>
                    <p class="event-subtitle">
                        <i class="fa-solid fa-people-group"></i>
                        {{ event.event_bookings.count }} going
                    </p>
                    <hr>
                    <article class="card-body card-text">
                    {{ event.description | safe }}
                    </article>
                    {% if event.date < now %}   
                    <div id="event-booking-details" class="section">
                        <p>This event has already past.<p>
                    </div> 
                    {% else %}
                    <div id="event-booking-details" class="section">
                        <!-- Cancel booking -->
                        {% if user.is_authenticated %}
                            {% if user_booking %}
                                <p>You have a space for this event.</p>
                                <button 
                                    type="button" 
                                    class="btn btn-outline-danger cancel-trigger" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#cancelEventFormModal"
                                    data-booking-id="{{ user_booking.id }}"
                                    data-slug="{{ event.slug }}">
                                    Cancel Booking
                                </button>
                            {% else %}
                                <!-- Book event form -->
                                <form method="POST" action="{% url 'events:book_event' event.slug %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success">
                                        Book
                                    </button>
                                </form>
                            {% endif %}
                        {% else %}
                        <p class="text-muted">Please <a href="{% url 'user:login' %}">Log in</a> to book.</p>
                        {% endif %}
                    </div>    
                    {% endif %}
                    <!-- Edit event if user is host -->                   
                    {% if user.is_authenticated and event.host == user %}
                    <hr>
                    <div id="edit-details" class="section">                    
                        <div id="edit-details-btnsConatiner">
                            <button 
                                class="btn btn-outline-secondary edit-btn" 
                                data-bs-toggle="modal" 
                                data-bs-target="#editEventFormModal"
                                data-title="{{ event.title }}"
                                data-date="{{ event.date|date:'Y-m-d\\TH:i' }}"
                                data-location="{{ event.location }}"
                                data-description="{{ event.description|escapejs }}"
                                data-slug="{{ event.slug }}"
                                data-status="{{ event.status }}"
                                >
                                Edit
                            </button>
                            <button 
                                class="btn btn-outline-danger delete-event-btn" 
                                data-bs-toggle="modal" 
                                data-bs-target="#deleteEventFormModal"
                                data-title="{{ event.title }}"
                                data-slug="{{ event.slug }}"
                                >
                                Delete
                            </button>                        
                        </div>
                    {% endif %}            
                    </div>                  
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit event modal -->
<div class="modal fade" id="editEventFormModal" tabindex="-1" role="dialog" aria-labelledby="edit-event-modal-title" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
  <form method="POST" enctype="multipart/form-data" action="{% url 'events:edit_event' event.slug %}">
        <input type="hidden" name="event_slug" id="eventSlugInput">                   
        <div class="modal-header">
          <h5 class="modal-title" id="edit-event-modal-title">Editing: {{ event.title }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% csrf_token %} 
          {{ edit_form | crispy }}
          {{ edit_form.media }}          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" name="publish" class="btn btn-success">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete event modal -->
<div class="modal fade" id="deleteEventFormModal" tabindex="-1" role="dialog" aria-labelledby="delete-event-modal-title" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
  <form method="POST" action="{% url 'events:delete_event' event.slug %}">
    <input type="hidden" name="event_slug_delete" id="eventDeleteSlugInput">                   
        <div class="modal-header">
          <h5 class="modal-title" id="delete-event-modal-title">Deleting Event</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
        {% csrf_token %} 
          <p>Are you sure you want to delete the event:<br><strong id="deleteEventName">{{ event.title }}</strong>?</p>
          <p class="text-muted mb-0">This action cannot be undone.</p> 
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" name="publish" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Cancel event modal -->
<div class="modal fade" id="cancelEventFormModal" tabindex="-1" role="dialog" aria-labelledby="cancel-event-modal-title" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
  <form id="cancelEventBookingForm" method="POST" action="{% if user_booking %}{% url 'events:cancel_event' event.slug user_booking.id %}{% else %}#{% endif %}">
        <input type="hidden" name="event_slug_cancel" id="eventCancelSlugInput">                   
            <div class="modal-header">
              <h5 class="modal-title" id="cancel-event-modal-title">Cancel booking</h5>
              <button type="button" class="btn-close cancel-booking-btn" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              {% csrf_token %} 
              <p>Are you sure you want to cancel your booking for the event:<br><strong id="cancelEventName">{{ event.title }}</strong>?</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, keep the booking</button>
              <button type="submit" name="publish" class="btn btn-danger cancel-event-booking-btn">Yes, Cancel</button>
            </div>
      </form>
    </div>
  </div>
</div>

{% endblock content %}
